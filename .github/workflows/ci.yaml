name: CI

on: [pull_request]

concurrency:
    group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
    cancel-in-progress: true

jobs:
    build:
        runs-on: ubuntu-latest
        timeout-minutes: 30

        steps:
            - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
              with:
                  fetch-depth: 0 # Important for Nx affected commands to work correctly

            - name: Install tools
              uses: jdx/mise-action@5ac50f778e26fac95da98d50503682459e86d566 # v3

            - uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4
              name: Install PNPM
              with:
                  run_install: false

            - name: Get PNPM store directory
              shell: bash
              run: |
                  echo "STORE_PATH=$(pnpm store path --silent)" >>$GITHUB_ENV

            - uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4
              name: Setup PNPM cache
              with:
                  path: ${{ env.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/.tool-versions') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Install PNPM dependencies
              run: pnpm install

            - name: Build Karabiner Config
              run: cd ./modules/home-manager/dotfiles/karabiner && pnpm build
